<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customer Orders</title>
    <style>
        /* Global */
        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f9fafb;
            color: #333;
            margin: 0;
            padding: 30px;
        }

        h1 {
            text-align: center;
            margin-bottom: 25px;
            font-size: 2rem;
            color: #2c3e50;
        }

        /* Table wrapper */
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        th, td {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            text-align: left;
            font-size: 0.95rem;
        }

        th {
            background: #f3f6f9;
            font-weight: 600;
            color: #444;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        tr:hover td {
            background: #f9fcff;
        }

        /* Items sub-table */
        .items-table {
            width: 100%;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            margin-top: 8px;
            font-size: 0.85rem;
        }

        .items-table th {
            background: #f7f9fb;
            color: #555;
            text-transform: none;
            font-size: 0.8rem;
        }

        .items-table td {
            border-bottom: 1px solid #eee;
            padding: 6px 10px;
        }

        .items-table tr:last-child td {
            border-bottom: none;
        }

        /* Dropdown + Button */
        select {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff;
            font-size: 0.9rem;
            cursor: pointer;
            transition: border 0.2s;
        }

        select:focus {
            border-color: #3498db;
            outline: none;
        }

        button {
            margin-left: 8px;
            padding: 6px 14px;
            font-size: 0.9rem;
            border: none;
            border-radius: 6px;
            background: #3498db;
            color: #fff;
            cursor: pointer;
            transition: background 0.25s ease, transform 0.15s ease;
        }

        button:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        .inventory-info {
            margin-top: 4px;
            font-size: 0.85rem;
            color: #555;
        }

        /* Receipt modal */
        #receiptModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.4);
            z-index: 9999;
        }

        #receiptContent {
            background: #fff;
            max-width: 400px;
            margin: 80px auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            position: relative;
        }

        #receiptTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #receiptTable th, #receiptTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        #receiptTable th {
            background: #f3f6f9;
            font-weight: 600;
        }
    </style>
</head>
<body>
<h1>Customer Orders</h1>
<table id="ordersTable">
    <thead>
    <tr>
        <th>Order ID</th>
        <th>Customer</th>
        <th>Employee</th>
        <th>Date</th>
        <th>Status</th>
        <th>Items</th>
        <th>Edit Status</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Receipt Modal -->
<div id="receiptModal">
    <div id="receiptContent">
        <h2 style="text-align:center;">Receipt</h2>
        <div id="receiptTable"></div>
        <button id="receiptDoneBtn" style="margin-top:20px;display:block;width:100%;background:#3498db;color:#fff;border:none;padding:10px 0;border-radius:8px;font-size:1rem;">Done</button>
    </div>
</div>

<script>
    function fetchOrders() {
        fetch('/orders/dto')
            .then(response => response.json())
            .then(data => {
                const tbody = document.querySelector('#ordersTable tbody');
                tbody.innerHTML = '';
                data.forEach(order => {
                    const row = document.createElement('tr');
                    // Items table
                    let itemsHtml = `<table class='items-table'><tr><th>Part</th><th>Qty</th><th>Price</th><th>Inventory</th></tr>`;
                    order.items.forEach((item, idx) => {
                        const inventoryBtn = `<button onclick="window.open('part_inventory.html?partId=${item.partId}', '_blank')">Check Inventory</button>`;
                        itemsHtml += `<tr id='item-row-${order.orderId}-${idx}'>
                            <td>${item.partName}</td>
                            <td>${item.quantity}</td>
                            <td>${item.price}</td>
                            <td>${inventoryBtn}</td>
                        </tr>`;
                    });
                    itemsHtml += `</table>`;
                    // Status dropdown
                    const statusOptions = ['Pending','Processing','Confirmed','Cancelled'];
                    let statusDropdown = `<select id='status-${order.orderId}'>`;
                    statusOptions.forEach(opt => {
                        statusDropdown += `<option value='${opt}'${order.status===opt?' selected':''}>${opt}</option>`;
                    });
                    statusDropdown += `</select>`;
                    // Update button
                    const updateBtn = `<button onclick="updateStatus(${order.orderId})">Update</button>`;
                    // Generate Receipt button (always available)
                    let receiptBtn = `<button onclick="generateReceipt(${order.orderId})">Generate Receipt</button>`;
                    row.innerHTML = `
          <td>${order.orderId}</td>
          <td>${order.customerName}</td>
          <td>${order.employeeName}</td>
          <td>${order.orderDate ? order.orderDate.substring(0,10) : ''}</td>
          <td>${order.status}</td>
          <td>${itemsHtml}</td>
          <td>${statusDropdown} ${updateBtn}<br>${receiptBtn}</td>
        `;
                    tbody.appendChild(row);
                });
            });
    }
    function updateStatus(orderId) {
        const status = document.getElementById('status-' + orderId).value;
        fetch(`/orders/${orderId}/status?status=${encodeURIComponent(status)}`, {
            method: 'PATCH'
        }).then(response => {
            if (response.ok) {
                alert('Order status updated!');
                fetchOrders();
            } else {
                alert('Failed to update status');
            }
        });
    }
    // Receipt modal
    if (!document.getElementById('receiptModal')) {
        const modal = document.createElement('div');
        modal.id = 'receiptModal';
        modal.style.display = 'none';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.4)';
        modal.style.zIndex = '9999';
        modal.innerHTML = `<div id='receiptContent' style='background:#fff;max-width:400px;margin:80px auto;padding:30px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.12);position:relative;'>
        <h2 style='text-align:center;'>Receipt</h2>
        <div id='receiptTable'></div>
        <button onclick="document.getElementById('receiptModal').style.display='none'" style='margin-top:20px;display:block;width:100%;background:#3498db;color:#fff;border:none;padding:10px 0;border-radius:8px;font-size:1rem;'>Close</button>
    </div>`;
        document.body.appendChild(modal);
    }
    let currentReceiptOrderId = null;
    function generateReceipt(orderId) {
        currentReceiptOrderId = orderId;
        fetch('/orders/dto')
            .then(response => response.json())
            .then(data => {
                const order = data.find(o => o.orderId === orderId);
                if (!order) return;
                let html = `<table style='width:100%;border-collapse:collapse;'>
                <tr><th style='text-align:left;'>Part Name</th><th>Qty</th><th>Price</th></tr>`;
                let total = 0;
                order.items.forEach(item => {
                    html += `<tr><td>${item.partName}</td><td>${item.quantity}</td><td>${item.price}</td></tr>`;
                    total += (item.price * item.quantity);
                });
                html += `<tr><td colspan='2' style='text-align:right;font-weight:bold;'>Total</td><td style='font-weight:bold;'>${total.toFixed(2)}</td></tr>`;
                html += `</table>`;
                document.getElementById('receiptTable').innerHTML = html;
                document.getElementById('receiptModal').style.display = 'block';
            });
    }
    document.getElementById('receiptDoneBtn').onclick = function() {
        if (currentReceiptOrderId) {
            fetch(`/orders/${currentReceiptOrderId}/reduce-stock`, { method: 'POST' })
                .then(response => response.ok ? response.text() : Promise.reject('Failed to update stock'))
                .then(msg => {
                    alert(msg);
                    document.getElementById('receiptModal').style.display = 'none';
                    fetchOrders();
                })
                .catch(err => {
                    alert(err);
                    document.getElementById('receiptModal').style.display = 'none';
                });
        } else {
            document.getElementById('receiptModal').style.display = 'none';
        }
    };
    fetchOrders();
</script>
</body>
</html>
